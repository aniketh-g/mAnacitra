<!DOCTYPE html>
<html lang="sa">
<head>
  <meta charset="utf-8" />
  <title>मानचित्रम्</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="style.css" />
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
</head>
<body>
<header>
  <h1>मानचित्रम्</h1>
  <nav>
    <a href="index.html" class="active">मानचित्रम्</a>
    <a href="about.html">अस्मद्विषये</a>
    <a href="feedback.html">प्रतिमन्त्रणम्</a>
  </nav>
</header>

<main>
  <div id="map"></div>
</main>

<aside id="sidebar">
  <header>
    <h2 id="sb-title"></h2>
    <button onclick="closeSidebar()">×</button>
  </header>
  <div class="content">
    
    <div class="row">
      <div class="label">स्वभाषायाम्</div>
      <div class="value" id="sb-native"></div>
    </div>

    <div class="row">
      <div class="label">आङ्ग्लायाम्</div>
      <div class="value" id="sb-english"></div>
    </div>

    <br>
    <div class="label big-label">विवरणम्</div>
    <div class="value notes" id="sb-notes"></div>

    <br>
    <hr>
    <br>

    <div class="label big-label">नामान्तराणि</div>
    <br> <!-- space after heading -->
    <div class="value" id="sb-altnames"></div>
  </div>
</aside>

<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script>

  let highlightedCountry = null;
  let highlightedCity = null;
  let highlightedRiver = null;

  function openSidebar(data) {
    document.getElementById("sb-title").innerHTML = data.sa || "";
    document.getElementById("sb-native").textContent = data.native || "";
    document.getElementById("sb-english").textContent = data.en || "";
    document.getElementById("sb-notes").innerHTML = data.notes || "";   // use innerHTML for <br>
    document.getElementById("sb-altnames").innerHTML = data.alts || ""; // use innerHTML for <strong> & <br>
    document.getElementById("sidebar").classList.add("open");
  }

  function closeSidebar() {
    document.getElementById("sidebar").classList.remove("open");
    map.setFilter('countries-fill', ['==', ['get', 'ADM0_A3'], '']);
    map.setFilter('capital-highlight', ['==', ['get', 'ADM0_A3'], '']);
    map.setFilter('rivers-highlight', ['==', ['get', 'name'], '']);
  }

  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      glyphs: "https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf",
      sources: { 
        basemap: { 
          type: 'raster', 
          tiles: ['https://a.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png',
                    'https://b.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png',
                    'https://c.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png'], 
          tileSize: 256 
        } 
      },
      layers: [ { id: 'basemap', type: 'raster', source: 'basemap' } ]
    },
    center: [0, 20],
    zoom: 2
  });

  map.on('load', () => {
    map.addSource('countries', {
      type: 'geojson',
      data: 'countries.geojson',
      generateId: true
    });
    map.addSource('cities', {
      type: 'geojson',
      data: 'cities.geojson'
    });
    map.addSource('rivers', {
      type: 'geojson',
      data: 'rivers.geojson'
    });

    // Deśāḥ
    map.addLayer({
      id: 'countries-fill',
      type: 'fill',
      source: 'countries',
      paint: {
        'fill-color': 'rgba(255,200,0,0.4)',
      },
      filter: ['==', ['get', 'ADM0_A3'], ''] // nothing selected initially
    });
    map.addLayer({
      id: 'countries-outline',
      type: 'line',
      source: 'countries',
      paint: {
        'line-color': '#999',
        'line-width': 1
      }
    });
    map.addLayer({
      minzoom: 2,
      id: 'countries-label',
      type: 'symbol',
      source: 'countries',
      layout: {
        'text-field': ['get', 'NAME_SA'],
        'text-font': ['Noto Sans Devanagari Regular v1'],
        'text-size': ['interpolate', ['linear'], ['zoom'],
                      2, 10,
                      5, 14,
                      8, 18],
        'text-anchor': 'center',
        'text-allow-overlap': false,
        'symbol-placement': 'point'
      },
      paint: {
        'text-color': '#000',
        'text-halo-color': '#fff',
        'text-halo-width': 1
      }
    });

    // Rājadhānyaḥ
    map.addLayer({
      minzoom: 3,
      id: 'capital-circles',
      type: 'circle',
      source: 'cities',
      filter: ['==', ['get', 'FEATURECLA'], 'Admin-0 capital'], // only capitals
      paint: {
        'circle-radius': ['interpolate', ['linear'], ['zoom'],
                      3, 2,
                      5, 3],
        'circle-color': '#fff',
        'circle-stroke-color': '#000',
        'circle-stroke-width': 2
      }
    });
    map.addLayer({
      minzoom: 3,
      id: 'capital-dot',
      type: 'circle',
      source: 'cities',
      filter: ['==', ['get', 'FEATURECLA'], 'Admin-0 capital'],
      paint: {
        'circle-radius': ['interpolate', ['linear'], ['zoom'],
                      3, 1,
                      5, 2],
        'circle-color': '#000'
      }
    });
    map.addLayer({
      id: 'capital-highlight',
      type: 'circle',
      source: 'cities',
      paint: {
        'circle-radius': 6,
        'circle-color': 'rgba(255,200,0,0.9)',
        'circle-stroke-color': '#000',
        'circle-stroke-width': 2
      },
      filter: ['==', ['get', 'ADM0_A3'], ''] // empty initially
    });
    map.addLayer({
      minzoom:3,
      id: 'capital-labels-sa',
      type: 'symbol',
      source: 'cities',
      filter: ['==', ['get', 'FEATURECLA'], 'Admin-0 capital'],
      layout: {
        'text-field': ['get', 'NAME_SA'],
        'text-font': ['Noto Sans Devanagari Regular v1'],
        'text-size': ['interpolate', ['linear'], ['zoom'],
                      3, 8,
                      5, 12,
                      8, 16],
        'text-anchor': 'bottom',     // anchor text relative to point
        'text-offset': [0, -0.8],    // move label upward
        'text-allow-overlap': false
      },
      paint: {
        'text-color': '#000',
        'text-halo-color': '#fff',
        'text-halo-width': 1
      }
    });

    // Saritaḥ
    map.addLayer({
      minzoom: 4,
      maxzoom: 9,
      id: 'rivers-line',
      type: 'line',
      source: 'rivers',
      paint: {
        'line-color': 'rgba(56, 179, 208, 0.5)',   // river blue
        'line-width': 1.2
      }
    });
    map.addLayer({
      id: 'rivers-highlight',
      type: 'line',
      source: 'rivers',
      paint: {
        'line-color': 'rgba(56, 179, 208, 0.9)',
        'line-width': 3
      },
      filter: ['==', ['get', 'ADM0_A3'], ''] // nothing selected
    });
    map.addLayer({
      id: 'rivers-labels',
      type: 'symbol',
      source: 'rivers',
      layout: {
        'text-field': ['get', 'NAME_SA'], // use the river name property
        'text-font': ['Noto Sans Devanagari Regular v1'], // or Shobhika/Noto Devanagari for Sanskrit names
        'text-size': 14,
        'symbol-placement': 'line',       // aligns text along river path
        'text-rotation-alignment': 'map',
        'text-keep-upright': true
      },
      paint: {
        'text-color': '#1ca3ec',
        'text-halo-color': '#fff',
        'text-halo-width': 1
      }
    });

  });

  // Clicking Logic
  const clickableLayers = ['countries-label', 'capital-labels-sa', 'rivers-labels'];

  // Hover cursor
  clickableLayers.forEach(layer => {
    map.on('mouseenter', layer, () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', layer, () => map.getCanvas().style.cursor = '');
  });
  // Close Sidebar
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeSidebar();
    }
  });


  map.on('click', (e) => {
    const features = map.queryRenderedFeatures(e.point, { layers: clickableLayers });
    if (!features.length) return;

    const feature = features[0];
    const props = feature.properties;

    // CLEAR ALL HIGHLIGHTS
    map.setFilter('countries-fill', ['==', ['get', 'ADM0_A3'], '']);
    map.setFilter('capital-highlight', ['==', ['get', 'ADM0_A3'], '']);
    map.setFilter('rivers-highlight', ['==', ['get', 'name'], '']);

    // APPLY CORRECT HIGHLIGHT
    if (feature.layer.id === 'countries-label') {
      map.setFilter('countries-fill', [
        '==',
        ['get', 'ADM0_A3'],
        props.ADM0_A3
      ]);
    }
    if (feature.layer.id === 'capital-labels-sa') {
      map.setFilter('capital-highlight', [
        '==',
        ['get', 'NAME_SA'],
        props.NAME_SA
      ]);
    }
    if (feature.layer.id === 'rivers-labels') {
      map.setFilter('rivers-highlight', [
        '==',
        ['get', 'NAME_SA'],
        props.NAME_SA
      ]);
    }

    // SIDEBAR (unchanged logic)
    const namesArray = JSON.parse(props.names_sanskrit || '[]');
    const primary = namesArray.find(n => n.primary) || {};
    const notesText = (primary.notes || "").replace(/\n/g, "<br>");

    // --- Alternates ---
    let alternates = namesArray
      .filter(n => !n.primary)
      .map(n => {
        return `
          <div class="alt-container">
            <div class="name-row">
              <div class="name-label"><strong>${n.name}</strong></div><div class="confidence-value">${n.confidence != null ? (n.confidence*100).toFixed(0) + '%' : ''}</div>
            </div>
            ${n.notes ? `<div class="alt-notes">${n.notes.replace(/\n/g, "<br>")}</div>` : ''}
          </div>
        `;
      })
      .join("") || "<em>नामान्तराण्यलभ्यानि</em>";

    // Confidence
    const primaryNameHtml = `
      <div class="name-row">
        <div class="name-label">${primary.name || ""}</div><div class="confidence-value">${primary.confidence != null ? (primary.confidence*100).toFixed(0) + '%' : ''}</div>
      </div>
    `;



    openSidebar({
      sa: primaryNameHtml,
      native: props.NAME || props.name || "",
      en: props.NAME_EN || props.name_en || "",
      notes: notesText,
      alts: alternates
    });
  });
</script>
</body>
</html>
